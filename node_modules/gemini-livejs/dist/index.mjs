import{WebSocket as f}from"ws";import{Writable as S}from"stream";import x from"node-wav";function g(u,i,e,t=1){let r=new Float32Array(u.length/2),s=0;for(;s<r.length;){let n=u.readInt16LE(s*2)/32768*t,a=Math.sign(n)*Math.min(Math.abs(n),1);r[s]=a,s++}return Buffer.from(x.encode([r],{sampleRate:i,float:!1,bitDepth:e}))}var h=u=>u?Array.isArray(u)?u.every(e=>typeof e=="object"&&e!==null&&"prompt"in e&&typeof e.prompt=="string"&&(!e.role||["user","gemini"].includes(e.role)))?{valid:!0}:{valid:!1,error:"Array input must contain objects with 'prompt' string and optional valid role"}:typeof u!="object"||u===null?{valid:!1,error:"Single input must be an object"}:!("prompt"in u)||typeof u.prompt!="string"?{valid:!1,error:"Single input must contain a 'prompt' string property"}:{valid:!0}:{valid:!1,error:"Input cannot be null or undefined"};var C=class{#e;#t={model:"models/gemini-2.0-flash-exp",generationConfig:{candidateCount:1,maxOutputTokens:2e3,temperature:.7,topP:1,topK:1,responseType:"TEXT",voiceName:"Puck"},systemInstruction:"",tools:[],safetySettings:[]};#i=!1;#a;#s;#l;#u;#d;#p;#n;#o;constructor(i,e){if(typeof i!="string")throw new TypeError(`[GeminiRealtime] Expected api_token to be a string, but received ${typeof i}.`);if(i.length===0)throw new ReferenceError("[GeminiRealtime] Api key must be provided.");this.#c(i,e),this.#s=new Promise(t=>{this.#l=t})}#c(i,e){let s=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${i}`;this.#e=new f(s),this.#e.on("open",()=>{this.#d?.(),this.#e?.send(JSON.stringify({setup:{model:this.#t.model,generationConfig:{candidateCount:this.#t.generationConfig.candidateCount,maxOutputTokens:e?.generationConfig?.maxOutputTokens||this.#t.generationConfig.maxOutputTokens,temperature:e?.generationConfig?.temperature||this.#t.generationConfig.temperature,topP:e?.generationConfig?.topP||this.#t.generationConfig.topP,topK:e?.generationConfig?.topK||this.#t.generationConfig.topK,responseModalities:[e?.generationConfig?.responseType||this.#t.generationConfig.responseType],speechConfig:{voice_config:{prebuilt_voice_config:{voice_name:e?.generationConfig?.voiceName||this.#t.generationConfig.voiceName}}}},systemInstruction:{parts:{text:e?.systemInstruction||this.#t.systemInstruction}},tools:e?.tools||this.#t.tools,safetySettings:e?.safetySettings||this.#t.safetySettings}}))}),this.#e.on("close",(o,n)=>{let a=n.toString(),d;if(a.includes("Request trace id:")){let[p,T]=a.split(", ");d={trace_id:p.split(": ")[1],code:o,reason:T}}else d={code:o,reason:a};this.#p?.(d)}),this.#e.on("message",o=>{try{let n=JSON.parse(o.toString());if(n.setupComplete){this.#u?.(),this.#m();return}if(n.toolCallCancellation){this.#i=!0;return}let a=n.serverContent;a&&this.#n?.(a);let d=n.toolCall;d&&this.#o?.(d)}catch(n){console.error("Error processing message:",n)}})}#m(){let i=e=>{if(this.#e?.readyState!==f.OPEN)return;let t=JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}});this.#e.send(t)};this.#a=new S({write:(e,t,r)=>{try{i(e),r()}catch(s){r(s)}}}),this.#l(this.#a)}#r(i){let e;if(i.audio.data.length>0){let t=Buffer.from(i.audio.data.join(""),"base64");e=g(t,24e3,16)}return i.functionCall||i.executableCode?{type:"function",role:"gemini",functionCall:i.functionCall,executableCode:i.executableCode}:{type:i.audio.mimeType.includes("audio/wav")?"audio":"text",role:"gemini",text:i.text.length>0?i.text.join("").trim():void 0,audio:i.audio.data.length>0?{mimeType:"audio/wav",data:e?.toString("base64")||""}:void 0}}async get_writable_stream(){return this.#s}async send(i,e=15e3){return new Promise((t,r)=>{let s=h(i);s.valid||r(new Error(`[GeminiRealtime::send] ${s.error}`)),(typeof e!="number"||e<=0)&&r(new Error(`[GeminiRealtime::send] Invalid timeout value: ${e}. Timeout must be a positive number (in milliseconds). Received type: ${typeof e}.`)),(!this.#e||this.#e.readyState!==f.OPEN)&&r(new Error("[GeminiRealtime::send] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client."));let o=setTimeout(()=>{this.#n=void 0,r(new Error(`[GeminiRealtime::send] Request timed out after ${e}ms`))},e),n={text:[],audio:{mimeType:"",data:[]}};this.#i=!1,this.#n=a=>{if(a.modelTurn?.parts){let d=0;for(;d<a.modelTurn.parts.length;){let p=a.modelTurn.parts[d];p.text?n.text.push(p.text):p.inlineData?(n.audio.mimeType||(n.audio.mimeType=p.inlineData.mimeType),n.audio.data.push(p.inlineData.data)):p.executableCode&&(n.executableCode=p.executableCode),d++}}a.turnComplete&&(this.#i?(n.text=[],n.audio.data=[],n.audio.mimeType="",n.functionCall=void 0,n.executableCode=void 0,this.#i=!1):(n.text.length>0||n.audio.data.length>0||n.functionCall||n.executableCode)&&(clearTimeout(o),this.#n=void 0,this.#o=void 0,t(this.#r(n))))},this.#o=a=>{a.functionCalls&&(n.functionCall=a.functionCalls[0],clearTimeout(o),this.#n=void 0,this.#o=void 0,this.#i=!1,t(this.#r(n)))};try{this.#e?.send(JSON.stringify({client_content:{turns:Array.isArray(i)?i.map(a=>({parts:[{text:a.prompt}],role:a.role||"user"})):[{parts:[{text:i.prompt}],role:"user"}],turn_complete:!0}}))}catch(a){clearTimeout(o),this.#n=void 0,this.#o=void 0,this.#i=!1,r(new Error(`[GeminiRealtime::send] Failed to send message: ${a.message}`))}})}realtime(i,e){if(!this.#e||this.#e.readyState!==f.OPEN)throw new Error("[GeminiRealtime::realtime] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client.");if(typeof i!="function")throw new TypeError(`[GeminiRealtime::realtime] Expected on_stream_response to be a function, but received ${typeof i}.`);if(e&&!Buffer.isBuffer(e))throw new TypeError(`[GeminiRealtime::realtime] Expected audio_input to be a Buffer, but received ${typeof e}.`);let t={text:[],audio:{mimeType:"",data:[]}};if(this.#i=!1,this.#n=r=>{if(r.modelTurn?.parts){let s=0;for(;s<r.modelTurn.parts.length;){let o=r.modelTurn.parts[s];o.text?t.text.push(o.text):o.inlineData?(t.audio.mimeType||(t.audio.mimeType=o.inlineData.mimeType),t.audio.data.push(o.inlineData.data)):o.executableCode&&(t.executableCode=o.executableCode),s++}}r.turnComplete&&(this.#i?(t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0,this.#i=!1):(t.text.length>0||t.audio.data.length>0||t.functionCall||t.executableCode)&&(i?.(this.#r(t)),t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0))},this.#o=r=>{r.functionCalls&&(t.functionCall=r.functionCalls[0],i?.(this.#r(t)))},!!e)try{this.#e?.send(JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}}))}catch(r){throw this.#n=void 0,this.#o=void 0,t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0,this.#i=!1,new Error(`[GeminiRealtime::send] Failed to send message: ${r.message}`)}}on_handshake(i){return this.#u=i,this}on_open(i){return this.#d=i,this}on_close(i){return this.#p=i,this}};var R=(n=>(n.UNSPECIFIED="TYPE_UNSPECIFIED",n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT",n))(R||{}),E=(e=>(e.UNSPECIFIED="MODE_UNSPECIFIED",e.DYNAMIC="MODE_DYNAMIC",e))(E||{}),_=(l=>(l.UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",l.DEROGATORY="HARM_CATEGORY_DEROGATORY",l.TOXICITY="HARM_CATEGORY_TOXICITY",l.VIOLENCE="HARM_CATEGORY_VIOLENCE",l.SEXUAL="HARM_CATEGORY_SEXUAL",l.MEDICAL="HARM_CATEGORY_MEDICAL",l.DANGEROUS="HARM_CATEGORY_DANGEROUS",l.HARASSMENT="HARM_CATEGORY_HARASSMENT",l.HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",l.SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",l.DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",l.CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",l))(_||{}),y=(o=>(o.UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",o.LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",o.MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",o.ONLY_HIGH="BLOCK_ONLY_HIGH",o.NONE="BLOCK_NONE",o.OFF="OFF",o))(y||{});var B=C;export{E as DynamicRetrievalMode,C as GeminiLive,y as HarmBlockThreshold,_ as HarmCategory,R as ParameterType,B as default};
