"use strict";var _=Object.create;var m=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var T=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty;var S=(a,e)=>{for(var t in e)m(a,t,{get:e[t],enumerable:!0})},p=(a,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of R(e))!w.call(a,n)&&n!==t&&m(a,n,{get:()=>e[n],enumerable:!(i=x(e,n))||i.enumerable});return a};var E=(a,e,t)=>(t=a!=null?_(T(a)):{},p(e||!a||!a.__esModule?m(t,"default",{value:a,enumerable:!0}):t,a)),P=a=>p(m({},"__esModule",{value:!0}),a);var k={};S(k,{GeminiLive:()=>c});module.exports=P(k);var f=require("ws"),b=require("stream");var g=E(require("node-wav"));function y(a,e,t,i=1){let n=new Float32Array(a.length/2),l=0;for(;l<n.length;){let o=a.readInt16LE(l*2)/32768*i,r=Math.sign(o)*Math.min(Math.abs(o),1);n[l]=r,l++}return Buffer.from(g.default.encode([n],{sampleRate:e,float:!1,bitDepth:t}))}var C=a=>a?Array.isArray(a)?a.every(t=>typeof t=="object"&&t!==null&&"prompt"in t&&typeof t.prompt=="string"&&(!t.role||["user","gemini"].includes(t.role)))?{valid:!0}:{valid:!1,error:"Array input must contain objects with 'prompt' string and optional valid role"}:typeof a!="object"||a===null?{valid:!1,error:"Single input must be an object"}:!("prompt"in a)||typeof a.prompt!="string"?{valid:!1,error:"Single input must contain a 'prompt' string property"}:{valid:!0}:{valid:!1,error:"Input cannot be null or undefined"};var c=class{#e;#t={model:"models/gemini-2.0-flash-exp",generationConfig:{candidateCount:1,maxOutputTokens:2e3,temperature:.7,topP:1,topK:1,responseType:"TEXT",voiceName:"Puck"},systemInstruction:"",tools:[],safetySettings:[]};#i=!1;#r;#s;#l;#d;#u;#f;#n;#o;constructor(e,t){if(typeof e!="string")throw new TypeError(`[GeminiRealtime] Expected api_token to be a string, but received ${typeof e}.`);if(e.length===0)throw new ReferenceError("[GeminiRealtime] Api key must be provided.");this.#m(e,t),this.#s=new Promise(i=>{this.#l=i})}#m(e,t){let l=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${e}`;this.#e=new f.WebSocket(l),this.#e.on("open",()=>{this.#u?.(),this.#e?.send(JSON.stringify({setup:{model:this.#t.model,generationConfig:{candidateCount:this.#t.generationConfig.candidateCount,maxOutputTokens:t?.generationConfig?.maxOutputTokens||this.#t.generationConfig.maxOutputTokens,temperature:t?.generationConfig?.temperature||this.#t.generationConfig.temperature,topP:t?.generationConfig?.topP||this.#t.generationConfig.topP,topK:t?.generationConfig?.topK||this.#t.generationConfig.topK,responseModalities:[t?.generationConfig?.responseType||this.#t.generationConfig.responseType],speechConfig:{voice_config:{prebuilt_voice_config:{voice_name:t?.generationConfig?.voiceName||this.#t.generationConfig.voiceName}}}},systemInstruction:{parts:{text:t?.systemInstruction||this.#t.systemInstruction}},tools:t?.tools||this.#t.tools,safetySettings:t?.safetySettings||this.#t.safetySettings}}))}),this.#e.on("close",(s,o)=>{let r=o.toString(),d;if(r.includes("Request trace id:")){let[u,v]=r.split(", ");d={trace_id:u.split(": ")[1],code:s,reason:v}}else d={code:s,reason:r};this.#f?.(d)}),this.#e.on("message",s=>{try{let o=JSON.parse(s.toString());if(o.setupComplete){this.#d?.(),this.#c();return}if(o.toolCallCancellation){this.#i=!0;return}let r=o.serverContent;r&&this.#n?.(r);let d=o.toolCall;d&&this.#o?.(d)}catch(o){console.error("Error processing message:",o)}})}#c(){let e=t=>{if(this.#e?.readyState!==f.WebSocket.OPEN)return;let i=JSON.stringify({realtime_input:{media_chunks:[{data:t.toString("base64"),mime_type:"audio/pcm"}]}});this.#e.send(i)};this.#r=new b.Writable({write:(t,i,n)=>{try{e(t),n()}catch(l){n(l)}}}),this.#l(this.#r)}#a(e){let t;if(e.audio.data.length>0){let i=Buffer.from(e.audio.data.join(""),"base64");t=y(i,24e3,16)}return e.functionCall||e.executableCode?{type:"function",role:"gemini",functionCall:e.functionCall,executableCode:e.executableCode}:{type:e.audio.mimeType.includes("audio/wav")?"audio":"text",role:"gemini",text:e.text.length>0?e.text.join("").trim():void 0,audio:e.audio.data.length>0?{mimeType:"audio/wav",data:t?.toString("base64")||""}:void 0}}async get_writable_stream(){return this.#s}async send(e,t=15e3){return new Promise((i,n)=>{let l=C(e);l.valid||n(new Error(`[GeminiRealtime::send] ${l.error}`)),(typeof t!="number"||t<=0)&&n(new Error(`[GeminiRealtime::send] Invalid timeout value: ${t}. Timeout must be a positive number (in milliseconds). Received type: ${typeof t}.`)),(!this.#e||this.#e.readyState!==f.WebSocket.OPEN)&&n(new Error("[GeminiRealtime::send] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client."));let s=setTimeout(()=>{this.#n=void 0,n(new Error(`[GeminiRealtime::send] Request timed out after ${t}ms`))},t),o={text:[],audio:{mimeType:"",data:[]}};this.#i=!1,this.#n=r=>{if(r.modelTurn?.parts){let d=0;for(;d<r.modelTurn.parts.length;){let u=r.modelTurn.parts[d];u.text?o.text.push(u.text):u.inlineData?(o.audio.mimeType||(o.audio.mimeType=u.inlineData.mimeType),o.audio.data.push(u.inlineData.data)):u.executableCode&&(o.executableCode=u.executableCode),d++}}r.turnComplete&&(this.#i?(o.text=[],o.audio.data=[],o.audio.mimeType="",o.functionCall=void 0,o.executableCode=void 0,this.#i=!1):(o.text.length>0||o.audio.data.length>0||o.functionCall||o.executableCode)&&(clearTimeout(s),this.#n=void 0,this.#o=void 0,i(this.#a(o))))},this.#o=r=>{r.functionCalls&&(o.functionCall=r.functionCalls[0],clearTimeout(s),this.#n=void 0,this.#o=void 0,this.#i=!1,i(this.#a(o)))};try{this.#e?.send(JSON.stringify({client_content:{turns:Array.isArray(e)?e.map(r=>({parts:[{text:r.prompt}],role:r.role||"user"})):[{parts:[{text:e.prompt}],role:"user"}],turn_complete:!0}}))}catch(r){clearTimeout(s),this.#n=void 0,this.#o=void 0,this.#i=!1,n(new Error(`[GeminiRealtime::send] Failed to send message: ${r.message}`))}})}realtime(e,t){if(!this.#e||this.#e.readyState!==f.WebSocket.OPEN)throw new Error("[GeminiRealtime::realtime] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client.");if(typeof e!="function")throw new TypeError(`[GeminiRealtime::realtime] Expected on_stream_response to be a function, but received ${typeof e}.`);if(t&&!Buffer.isBuffer(t))throw new TypeError(`[GeminiRealtime::realtime] Expected audio_input to be a Buffer, but received ${typeof t}.`);let i={text:[],audio:{mimeType:"",data:[]}};if(this.#i=!1,this.#n=n=>{if(n.modelTurn?.parts){let l=0;for(;l<n.modelTurn.parts.length;){let s=n.modelTurn.parts[l];s.text?i.text.push(s.text):s.inlineData?(i.audio.mimeType||(i.audio.mimeType=s.inlineData.mimeType),i.audio.data.push(s.inlineData.data)):s.executableCode&&(i.executableCode=s.executableCode),l++}}n.turnComplete&&(this.#i?(i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0,this.#i=!1):(i.text.length>0||i.audio.data.length>0||i.functionCall||i.executableCode)&&(e?.(this.#a(i)),i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0))},this.#o=n=>{n.functionCalls&&(i.functionCall=n.functionCalls[0],e?.(this.#a(i)))},!!t)try{this.#e?.send(JSON.stringify({realtime_input:{media_chunks:[{data:t.toString("base64"),mime_type:"audio/pcm"}]}}))}catch(n){throw this.#n=void 0,this.#o=void 0,i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0,this.#i=!1,new Error(`[GeminiRealtime::send] Failed to send message: ${n.message}`)}}on_handshake(e){return this.#d=e,this}on_open(e){return this.#u=e,this}on_close(e){return this.#f=e,this}};0&&(module.exports={GeminiLive});
