import{WebSocket as f}from"ws";import{Writable as b}from"stream";import C from"node-wav";function p(l,i,e,t=1){let o=new Float32Array(l.length/2),s=0;for(;s<o.length;){let n=l.readInt16LE(s*2)/32768*t,a=Math.sign(n)*Math.min(Math.abs(n),1);o[s]=a,s++}return Buffer.from(C.encode([o],{sampleRate:i,float:!1,bitDepth:e}))}var h=l=>l?Array.isArray(l)?l.every(e=>typeof e=="object"&&e!==null&&"prompt"in e&&typeof e.prompt=="string"&&(!e.role||["user","gemini"].includes(e.role)))?{valid:!0}:{valid:!1,error:"Array input must contain objects with 'prompt' string and optional valid role"}:typeof l!="object"||l===null?{valid:!1,error:"Single input must be an object"}:!("prompt"in l)||typeof l.prompt!="string"?{valid:!1,error:"Single input must contain a 'prompt' string property"}:{valid:!0}:{valid:!1,error:"Input cannot be null or undefined"};var g=class{#e;#t={model:"models/gemini-2.0-flash-exp",generationConfig:{candidateCount:1,maxOutputTokens:2e3,temperature:.7,topP:1,topK:1,responseType:"TEXT",voiceName:"Puck"},systemInstruction:"",tools:[],safetySettings:[]};#i=!1;#r;#s;#l;#d;#u;#f;#n;#o;constructor(i,e){if(typeof i!="string")throw new TypeError(`[GeminiRealtime] Expected api_token to be a string, but received ${typeof i}.`);if(i.length===0)throw new ReferenceError("[GeminiRealtime] Api key must be provided.");this.#m(i,e),this.#s=new Promise(t=>{this.#l=t})}#m(i,e){let s=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${i}`;this.#e=new f(s),this.#e.on("open",()=>{this.#u?.(),this.#e?.send(JSON.stringify({setup:{model:this.#t.model,generationConfig:{candidateCount:this.#t.generationConfig.candidateCount,maxOutputTokens:e?.generationConfig?.maxOutputTokens||this.#t.generationConfig.maxOutputTokens,temperature:e?.generationConfig?.temperature||this.#t.generationConfig.temperature,topP:e?.generationConfig?.topP||this.#t.generationConfig.topP,topK:e?.generationConfig?.topK||this.#t.generationConfig.topK,responseModalities:[e?.generationConfig?.responseType||this.#t.generationConfig.responseType],speechConfig:{voice_config:{prebuilt_voice_config:{voice_name:e?.generationConfig?.voiceName||this.#t.generationConfig.voiceName}}}},systemInstruction:{parts:{text:e?.systemInstruction||this.#t.systemInstruction}},tools:e?.tools||this.#t.tools,safetySettings:e?.safetySettings||this.#t.safetySettings}}))}),this.#e.on("close",(r,n)=>{let a=n.toString(),d;if(a.includes("Request trace id:")){let[u,y]=a.split(", ");d={trace_id:u.split(": ")[1],code:r,reason:y}}else d={code:r,reason:a};this.#f?.(d)}),this.#e.on("message",r=>{try{let n=JSON.parse(r.toString());if(n.setupComplete){this.#d?.(),this.#c();return}if(n.toolCallCancellation){this.#i=!0;return}let a=n.serverContent;a&&this.#n?.(a);let d=n.toolCall;d&&this.#o?.(d)}catch(n){console.error("Error processing message:",n)}})}#c(){let i=e=>{if(this.#e?.readyState!==f.OPEN)return;let t=JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}});this.#e.send(t)};this.#r=new b({write:(e,t,o)=>{try{i(e),o()}catch(s){o(s)}}}),this.#l(this.#r)}#a(i){let e;if(i.audio.data.length>0){let t=Buffer.from(i.audio.data.join(""),"base64");e=p(t,24e3,16)}return i.functionCall||i.executableCode?{type:"function",role:"gemini",functionCall:i.functionCall,executableCode:i.executableCode}:{type:i.audio.mimeType.includes("audio/wav")?"audio":"text",role:"gemini",text:i.text.length>0?i.text.join("").trim():void 0,audio:i.audio.data.length>0?{mimeType:"audio/wav",data:e?.toString("base64")||""}:void 0}}async get_writable_stream(){return this.#s}async send(i,e=15e3){return new Promise((t,o)=>{let s=h(i);s.valid||o(new Error(`[GeminiRealtime::send] ${s.error}`)),(typeof e!="number"||e<=0)&&o(new Error(`[GeminiRealtime::send] Invalid timeout value: ${e}. Timeout must be a positive number (in milliseconds). Received type: ${typeof e}.`)),(!this.#e||this.#e.readyState!==f.OPEN)&&o(new Error("[GeminiRealtime::send] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client."));let r=setTimeout(()=>{this.#n=void 0,o(new Error(`[GeminiRealtime::send] Request timed out after ${e}ms`))},e),n={text:[],audio:{mimeType:"",data:[]}};this.#i=!1,this.#n=a=>{if(a.modelTurn?.parts){let d=0;for(;d<a.modelTurn.parts.length;){let u=a.modelTurn.parts[d];u.text?n.text.push(u.text):u.inlineData?(n.audio.mimeType||(n.audio.mimeType=u.inlineData.mimeType),n.audio.data.push(u.inlineData.data)):u.executableCode&&(n.executableCode=u.executableCode),d++}}a.turnComplete&&(this.#i?(n.text=[],n.audio.data=[],n.audio.mimeType="",n.functionCall=void 0,n.executableCode=void 0,this.#i=!1):(n.text.length>0||n.audio.data.length>0||n.functionCall||n.executableCode)&&(clearTimeout(r),this.#n=void 0,this.#o=void 0,t(this.#a(n))))},this.#o=a=>{a.functionCalls&&(n.functionCall=a.functionCalls[0],clearTimeout(r),this.#n=void 0,this.#o=void 0,this.#i=!1,t(this.#a(n)))};try{this.#e?.send(JSON.stringify({client_content:{turns:Array.isArray(i)?i.map(a=>({parts:[{text:a.prompt}],role:a.role||"user"})):[{parts:[{text:i.prompt}],role:"user"}],turn_complete:!0}}))}catch(a){clearTimeout(r),this.#n=void 0,this.#o=void 0,this.#i=!1,o(new Error(`[GeminiRealtime::send] Failed to send message: ${a.message}`))}})}realtime(i,e){if(!this.#e||this.#e.readyState!==f.OPEN)throw new Error("[GeminiRealtime::realtime] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client.");if(typeof i!="function")throw new TypeError(`[GeminiRealtime::realtime] Expected on_stream_response to be a function, but received ${typeof i}.`);if(e&&!Buffer.isBuffer(e))throw new TypeError(`[GeminiRealtime::realtime] Expected audio_input to be a Buffer, but received ${typeof e}.`);let t={text:[],audio:{mimeType:"",data:[]}};if(this.#i=!1,this.#n=o=>{if(o.modelTurn?.parts){let s=0;for(;s<o.modelTurn.parts.length;){let r=o.modelTurn.parts[s];r.text?t.text.push(r.text):r.inlineData?(t.audio.mimeType||(t.audio.mimeType=r.inlineData.mimeType),t.audio.data.push(r.inlineData.data)):r.executableCode&&(t.executableCode=r.executableCode),s++}}o.turnComplete&&(this.#i?(t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0,this.#i=!1):(t.text.length>0||t.audio.data.length>0||t.functionCall||t.executableCode)&&(i?.(this.#a(t)),t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0))},this.#o=o=>{o.functionCalls&&(t.functionCall=o.functionCalls[0],i?.(this.#a(t)))},!!e)try{this.#e?.send(JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}}))}catch(o){throw this.#n=void 0,this.#o=void 0,t.text=[],t.audio.data=[],t.audio.mimeType="",t.functionCall=void 0,t.executableCode=void 0,this.#i=!1,new Error(`[GeminiRealtime::send] Failed to send message: ${o.message}`)}}on_handshake(i){return this.#d=i,this}on_open(i){return this.#u=i,this}on_close(i){return this.#f=i,this}};export{g as GeminiLive};
