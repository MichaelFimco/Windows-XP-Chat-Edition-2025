"use strict";var b=Object.create;var f=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var v=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var G=(r,t)=>{for(var e in t)f(r,e,{get:t[e],enumerable:!0})},_=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of I(t))!N.call(r,o)&&o!==e&&f(r,o,{get:()=>t[o],enumerable:!(i=O(t,o))||i.enumerable});return r};var w=(r,t,e)=>(e=r!=null?b(v(r)):{},_(t||!r||!r.__esModule?f(e,"default",{value:r,enumerable:!0}):e,r)),D=r=>_(f({},"__esModule",{value:!0}),r);var M={};G(M,{DynamicRetrievalMode:()=>h,GeminiLive:()=>m,HarmBlockThreshold:()=>E,HarmCategory:()=>R,ParameterType:()=>g,default:()=>P});module.exports=D(M);var c=require("ws"),S=require("stream");var y=w(require("node-wav"));function T(r,t,e,i=1){let o=new Float32Array(r.length/2),l=0;for(;l<o.length;){let n=r.readInt16LE(l*2)/32768*i,s=Math.sign(n)*Math.min(Math.abs(n),1);o[l]=s,l++}return Buffer.from(y.default.encode([o],{sampleRate:t,float:!1,bitDepth:e}))}var x=r=>r?Array.isArray(r)?r.every(e=>typeof e=="object"&&e!==null&&"prompt"in e&&typeof e.prompt=="string"&&(!e.role||["user","gemini"].includes(e.role)))?{valid:!0}:{valid:!1,error:"Array input must contain objects with 'prompt' string and optional valid role"}:typeof r!="object"||r===null?{valid:!1,error:"Single input must be an object"}:!("prompt"in r)||typeof r.prompt!="string"?{valid:!1,error:"Single input must contain a 'prompt' string property"}:{valid:!0}:{valid:!1,error:"Input cannot be null or undefined"};var m=class{#e;#t={model:"models/gemini-2.0-flash-exp",generationConfig:{candidateCount:1,maxOutputTokens:2e3,temperature:.7,topP:1,topK:1,responseType:"TEXT",voiceName:"Puck"},systemInstruction:"",tools:[],safetySettings:[]};#i=!1;#a;#s;#l;#u;#d;#p;#n;#o;constructor(t,e){if(typeof t!="string")throw new TypeError(`[GeminiRealtime] Expected api_token to be a string, but received ${typeof t}.`);if(t.length===0)throw new ReferenceError("[GeminiRealtime] Api key must be provided.");this.#c(t,e),this.#s=new Promise(i=>{this.#l=i})}#c(t,e){let l=`wss://generativelanguage.googleapis.com/ws/google.ai.generativelanguage.v1alpha.GenerativeService.BidiGenerateContent?key=${t}`;this.#e=new c.WebSocket(l),this.#e.on("open",()=>{this.#d?.(),this.#e?.send(JSON.stringify({setup:{model:this.#t.model,generationConfig:{candidateCount:this.#t.generationConfig.candidateCount,maxOutputTokens:e?.generationConfig?.maxOutputTokens||this.#t.generationConfig.maxOutputTokens,temperature:e?.generationConfig?.temperature||this.#t.generationConfig.temperature,topP:e?.generationConfig?.topP||this.#t.generationConfig.topP,topK:e?.generationConfig?.topK||this.#t.generationConfig.topK,responseModalities:[e?.generationConfig?.responseType||this.#t.generationConfig.responseType],speechConfig:{voice_config:{prebuilt_voice_config:{voice_name:e?.generationConfig?.voiceName||this.#t.generationConfig.voiceName}}}},systemInstruction:{parts:{text:e?.systemInstruction||this.#t.systemInstruction}},tools:e?.tools||this.#t.tools,safetySettings:e?.safetySettings||this.#t.safetySettings}}))}),this.#e.on("close",(a,n)=>{let s=n.toString(),d;if(s.includes("Request trace id:")){let[p,A]=s.split(", ");d={trace_id:p.split(": ")[1],code:a,reason:A}}else d={code:a,reason:s};this.#p?.(d)}),this.#e.on("message",a=>{try{let n=JSON.parse(a.toString());if(n.setupComplete){this.#u?.(),this.#m();return}if(n.toolCallCancellation){this.#i=!0;return}let s=n.serverContent;s&&this.#n?.(s);let d=n.toolCall;d&&this.#o?.(d)}catch(n){console.error("Error processing message:",n)}})}#m(){let t=e=>{if(this.#e?.readyState!==c.WebSocket.OPEN)return;let i=JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}});this.#e.send(i)};this.#a=new S.Writable({write:(e,i,o)=>{try{t(e),o()}catch(l){o(l)}}}),this.#l(this.#a)}#r(t){let e;if(t.audio.data.length>0){let i=Buffer.from(t.audio.data.join(""),"base64");e=T(i,24e3,16)}return t.functionCall||t.executableCode?{type:"function",role:"gemini",functionCall:t.functionCall,executableCode:t.executableCode}:{type:t.audio.mimeType.includes("audio/wav")?"audio":"text",role:"gemini",text:t.text.length>0?t.text.join("").trim():void 0,audio:t.audio.data.length>0?{mimeType:"audio/wav",data:e?.toString("base64")||""}:void 0}}async get_writable_stream(){return this.#s}async send(t,e=15e3){return new Promise((i,o)=>{let l=x(t);l.valid||o(new Error(`[GeminiRealtime::send] ${l.error}`)),(typeof e!="number"||e<=0)&&o(new Error(`[GeminiRealtime::send] Invalid timeout value: ${e}. Timeout must be a positive number (in milliseconds). Received type: ${typeof e}.`)),(!this.#e||this.#e.readyState!==c.WebSocket.OPEN)&&o(new Error("[GeminiRealtime::send] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client."));let a=setTimeout(()=>{this.#n=void 0,o(new Error(`[GeminiRealtime::send] Request timed out after ${e}ms`))},e),n={text:[],audio:{mimeType:"",data:[]}};this.#i=!1,this.#n=s=>{if(s.modelTurn?.parts){let d=0;for(;d<s.modelTurn.parts.length;){let p=s.modelTurn.parts[d];p.text?n.text.push(p.text):p.inlineData?(n.audio.mimeType||(n.audio.mimeType=p.inlineData.mimeType),n.audio.data.push(p.inlineData.data)):p.executableCode&&(n.executableCode=p.executableCode),d++}}s.turnComplete&&(this.#i?(n.text=[],n.audio.data=[],n.audio.mimeType="",n.functionCall=void 0,n.executableCode=void 0,this.#i=!1):(n.text.length>0||n.audio.data.length>0||n.functionCall||n.executableCode)&&(clearTimeout(a),this.#n=void 0,this.#o=void 0,i(this.#r(n))))},this.#o=s=>{s.functionCalls&&(n.functionCall=s.functionCalls[0],clearTimeout(a),this.#n=void 0,this.#o=void 0,this.#i=!1,i(this.#r(n)))};try{this.#e?.send(JSON.stringify({client_content:{turns:Array.isArray(t)?t.map(s=>({parts:[{text:s.prompt}],role:s.role||"user"})):[{parts:[{text:t.prompt}],role:"user"}],turn_complete:!0}}))}catch(s){clearTimeout(a),this.#n=void 0,this.#o=void 0,this.#i=!1,o(new Error(`[GeminiRealtime::send] Failed to send message: ${s.message}`))}})}realtime(t,e){if(!this.#e||this.#e.readyState!==c.WebSocket.OPEN)throw new Error("[GeminiRealtime::realtime] WebSocket connection failed. Please verify your API token and generation config are valid, then reinitialize the client.");if(typeof t!="function")throw new TypeError(`[GeminiRealtime::realtime] Expected on_stream_response to be a function, but received ${typeof t}.`);if(e&&!Buffer.isBuffer(e))throw new TypeError(`[GeminiRealtime::realtime] Expected audio_input to be a Buffer, but received ${typeof e}.`);let i={text:[],audio:{mimeType:"",data:[]}};if(this.#i=!1,this.#n=o=>{if(o.modelTurn?.parts){let l=0;for(;l<o.modelTurn.parts.length;){let a=o.modelTurn.parts[l];a.text?i.text.push(a.text):a.inlineData?(i.audio.mimeType||(i.audio.mimeType=a.inlineData.mimeType),i.audio.data.push(a.inlineData.data)):a.executableCode&&(i.executableCode=a.executableCode),l++}}o.turnComplete&&(this.#i?(i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0,this.#i=!1):(i.text.length>0||i.audio.data.length>0||i.functionCall||i.executableCode)&&(t?.(this.#r(i)),i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0))},this.#o=o=>{o.functionCalls&&(i.functionCall=o.functionCalls[0],t?.(this.#r(i)))},!!e)try{this.#e?.send(JSON.stringify({realtime_input:{media_chunks:[{data:e.toString("base64"),mime_type:"audio/pcm"}]}}))}catch(o){throw this.#n=void 0,this.#o=void 0,i.text=[],i.audio.data=[],i.audio.mimeType="",i.functionCall=void 0,i.executableCode=void 0,this.#i=!1,new Error(`[GeminiRealtime::send] Failed to send message: ${o.message}`)}}on_handshake(t){return this.#u=t,this}on_open(t){return this.#d=t,this}on_close(t){return this.#p=t,this}};var g=(n=>(n.UNSPECIFIED="TYPE_UNSPECIFIED",n.STRING="STRING",n.NUMBER="NUMBER",n.INTEGER="INTEGER",n.BOOLEAN="BOOLEAN",n.ARRAY="ARRAY",n.OBJECT="OBJECT",n))(g||{}),h=(e=>(e.UNSPECIFIED="MODE_UNSPECIFIED",e.DYNAMIC="MODE_DYNAMIC",e))(h||{}),R=(u=>(u.UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",u.DEROGATORY="HARM_CATEGORY_DEROGATORY",u.TOXICITY="HARM_CATEGORY_TOXICITY",u.VIOLENCE="HARM_CATEGORY_VIOLENCE",u.SEXUAL="HARM_CATEGORY_SEXUAL",u.MEDICAL="HARM_CATEGORY_MEDICAL",u.DANGEROUS="HARM_CATEGORY_DANGEROUS",u.HARASSMENT="HARM_CATEGORY_HARASSMENT",u.HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",u.SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",u.DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",u.CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",u))(R||{}),E=(a=>(a.UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",a.LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",a.MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",a.ONLY_HIGH="BLOCK_ONLY_HIGH",a.NONE="BLOCK_NONE",a.OFF="OFF",a))(E||{});var P=m;0&&(module.exports={DynamicRetrievalMode,GeminiLive,HarmBlockThreshold,HarmCategory,ParameterType});
